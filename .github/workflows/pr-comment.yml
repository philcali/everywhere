name: PR Comment

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm run install:all
    
    - name: Check for changes in workspaces
      id: changes
      run: |
        echo "frontend=$(git diff --name-only origin/main...HEAD | grep '^frontend/' | wc -l)" >> $GITHUB_OUTPUT
        echo "backend=$(git diff --name-only origin/main...HEAD | grep '^backend/' | wc -l)" >> $GITHUB_OUTPUT
        echo "shared=$(git diff --name-only origin/main...HEAD | grep '^shared/' | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Run tests and build
      id: build
      run: |
        set +e  # Don't exit on error
        
        # Run tests
        npm run test > test_output.log 2>&1
        TEST_EXIT_CODE=$?
        
        # Run build
        npm run build > build_output.log 2>&1
        BUILD_EXIT_CODE=$?
        
        # Set outputs
        echo "test_status=$([[ $TEST_EXIT_CODE -eq 0 ]] && echo 'success' || echo 'failure')" >> $GITHUB_OUTPUT
        echo "build_status=$([[ $BUILD_EXIT_CODE -eq 0 ]] && echo 'success' || echo 'failure')" >> $GITHUB_OUTPUT
        echo "overall_status=$([[ $TEST_EXIT_CODE -eq 0 && $BUILD_EXIT_CODE -eq 0 ]] && echo 'success' || echo 'failure')" >> $GITHUB_OUTPUT
        
        # Exit with error if either failed (for workflow status)
        exit $((TEST_EXIT_CODE + BUILD_EXIT_CODE))
      continue-on-error: true
    
    - name: Comment on PR
      uses: actions/github-script@v8
      if: always()
      with:
        script: |
          const prNumber = context.issue.number;
          const testStatus = '${{ steps.build.outputs.test_status }}' === 'success' ? 'âœ…' : 'âŒ';
          const buildStatus = '${{ steps.build.outputs.build_status }}' === 'success' ? 'âœ…' : 'âŒ';
          const overallStatus = '${{ steps.build.outputs.overall_status }}' === 'success' ? 'âœ… All Checks Passed' : 'âŒ Some Checks Failed';
          
          const frontendChanges = '${{ steps.changes.outputs.frontend }}' || '0';
          const backendChanges = '${{ steps.changes.outputs.backend }}' || '0';
          const sharedChanges = '${{ steps.changes.outputs.shared }}' || '0';
          
          const body = `## ${overallStatus}
          
### Test Results
${testStatus} **Tests**: ${{ steps.build.outputs.test_status }}
${buildStatus} **Build**: ${{ steps.build.outputs.build_status }}

### Changes Detected
- ðŸ“± Frontend: ${frontendChanges} files
- ðŸ”§ Backend: ${backendChanges} files  
- ðŸ“¦ Shared: ${sharedChanges} files

### Details
- **Commit**: ${context.sha.substring(0, 7)}
- **Workflow**: [${context.runId}](${context.payload.repository.html_url}/actions/runs/${context.runId})
- **Completed**: ${new Date().toISOString()}

---
*This comment was automatically generated by GitHub Actions*`;
          
          // Find existing bot comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const existingComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('All Checks Passed') || comment.body.includes('Some Checks Failed')
          );
          
          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
          }