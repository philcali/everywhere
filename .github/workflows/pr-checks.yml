name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm run install:all
    
    - name: Check for changes in workspaces
      id: changes
      run: |
        echo "frontend=$(git diff --name-only origin/main...HEAD | grep '^frontend/' | wc -l)" >> $GITHUB_OUTPUT
        echo "backend=$(git diff --name-only origin/main...HEAD | grep '^backend/' | wc -l)" >> $GITHUB_OUTPUT
        echo "shared=$(git diff --name-only origin/main...HEAD | grep '^shared/' | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Test shared package
      if: steps.changes.outputs.shared > 0
      run: cd shared && npm run test
    
    - name: Test backend
      if: steps.changes.outputs.backend > 0 || steps.changes.outputs.shared > 0
      run: cd backend && npm run test
    
    - name: Test frontend
      if: steps.changes.outputs.frontend > 0 || steps.changes.outputs.shared > 0
      run: cd frontend && npm run test
    
    - name: Build affected packages
      run: |
        npm run build
    
    - name: Comment PR with build status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Build Status')
          );
          
          const status = '${{ job.status }}' === 'success' ? '✅ Passed' : '❌ Failed';
          const body = `## Build Status: ${status}
          
          - Frontend changes: ${{ steps.changes.outputs.frontend }} files
          - Backend changes: ${{ steps.changes.outputs.backend }} files  
          - Shared changes: ${{ steps.changes.outputs.shared }} files
          
          Build completed at: ${new Date().toISOString()}`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }