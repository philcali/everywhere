name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm run install:all
    
    - name: Check for changes in workspaces
      id: changes
      run: |
        echo "frontend=$(git diff --name-only origin/main...HEAD | grep '^frontend/' | wc -l)" >> $GITHUB_OUTPUT
        echo "backend=$(git diff --name-only origin/main...HEAD | grep '^backend/' | wc -l)" >> $GITHUB_OUTPUT
        echo "shared=$(git diff --name-only origin/main...HEAD | grep '^shared/' | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Test shared package
      if: steps.changes.outputs.shared > 0
      run: cd shared && npm run test
    
    - name: Test backend
      if: steps.changes.outputs.backend > 0 || steps.changes.outputs.shared > 0
      run: cd backend && npm run test
    
    - name: Test frontend
      if: steps.changes.outputs.frontend > 0 || steps.changes.outputs.shared > 0
      run: cd frontend && npm run test
    
    - name: Build affected packages
      run: |
        npm run build
    
    - name: Comment PR with build status
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Only run on pull requests
          if (!context.payload.pull_request) {
            console.log('Not a pull request, skipping comment');
            return;
          }
          
          const prNumber = context.payload.pull_request.number;
          
          try {
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user?.type === 'Bot' && comment.body.includes('Build Status')
            );
            
            const status = '${{ job.status }}' === 'success' ? '‚úÖ Passed' : '‚ùå Failed';
            const frontendChanges = '${{ steps.changes.outputs.frontend }}' || '0';
            const backendChanges = '${{ steps.changes.outputs.backend }}' || '0';
            const sharedChanges = '${{ steps.changes.outputs.shared }}' || '0';
            
            const body = `## Build Status: ${status}

            ### Changes Detected
            - üì± Frontend: ${frontendChanges} files
            - üîß Backend: ${backendChanges} files
            - üì¶ Shared: ${sharedChanges} files

            ### Details
            - **Commit**: ${context.sha.substring(0, 7)}
            - **Workflow**: [${context.runId}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - **Completed**: ${new Date().toISOString()}

            ---
            *This comment was automatically generated by GitHub Actions*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('Created new comment');
            }
          } catch (error) {
            console.error('Error commenting on PR:', error);
            // Don't fail the workflow if commenting fails
          }